<!DOCTYPE html>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ†–</text></svg>">
<label for=url>url:</label>
<input type=text id=url name=url>
<br>
<label for=speed>speed:</label>
<input type=number id=speed name=speed value=1.0 step=0.1>
<br>
<label for=filetype>file type:</label>
<select id=filetype name=filetype>
  <option>mp3</option>
  <option>mp4</option>
</select>
<br>
<button>download</button>
<div id=serveroutput></div>

<script>
const websocket = new WebSocket('/slowmedownsocket');
let websocketId = null;
websocket.addEventListener('message', event => {
  if (!websocketId) {
    console.log('assigning websocketId of ' + event.data, event);
    websocketId = event.data;
  }
  document.getElementById('serveroutput').appendChild(new Text(event.data));
});

const button = document.querySelector('button');
button.onclick = async () => {
  const url = document.getElementById('url').value;
  const speed = document.getElementById('speed').value;
  const filetype = document.getElementById('filetype').value;
  const options = {
    headers: {
      accept: '*/*',
      'x-websocket-id': websocketId
    }
  };
  const response = await fetch(
    '/slowmedownload?' + new URLSearchParams({url, speed, filetype}).toString(), options);
  const blob = await response.blob();
  const file = window.URL.createObjectURL(blob);
  window.location.assign(file);
  // TODO try doing this instead of navigating to the file:
  /*const a = document.createElement('a');
  a.href = file;
  document.body.appendChild(a);
  a.click();
  a.remove();*/
};
</script>

<style>
#serveroutput {
  height: 200px;
  overflow-y: scroll;
  white-space: pre;
  font-family: monospace;
}
</style>
